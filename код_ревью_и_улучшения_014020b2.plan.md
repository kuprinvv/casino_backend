---
name: Код ревью и улучшения
overview: Проведен полный анализ кодовой базы casino_backend. Выявлены критические проблемы безопасности, архитектурные недостатки, проблемы с обработкой ошибок и множество мест для улучшения. План содержит детальные рекомендации с примерами кода.
todos: []
---

# Код ревью проекта casino_backend

## Критические проблемы безопасности

### 1. Использование panic вместо возврата ошибок

**Файл:** `internal/app/service_provider.go`

**Проблема:** Использование `panic` в инициализации может привести к падению приложения

**Пример:**

```61:internal/app/service_provider.go
panic("failed to get database config: " + err.Error())
```

**Решение:** Заменить на возврат ошибок и graceful shutdown

### 2. Небезопасные cookie настройки

**Файл:** `internal/api/auth/auth.go`

**Проблема:**

- `Secure: false` в production (строка 154, 180)
- `Path: "/refresh"` для refresh_token ограничивает использование (строка 152)
- Несоответствие настроек Secure между установкой и удалением cookie

**Решение:** Использовать переменные окружения для определения окружения

### 3. CORS настроен на "*" (разрешает все домены)

**Файл:** `internal/app/service_provider.go:197`

**Проблема:** `AllowedOrigins: []string{"*"}` - небезопасно для production

**Решение:** Использовать whitelist доменов из конфигурации

### 4. Отсутствие rate limiting

**Проблема:** Нет защиты от брутфорса и DDoS

**Решение:** Добавить middleware для rate limiting

### 5. Race conditions в обновлении баланса

**Файлы:** `internal/service/cascade/spin.go`, `internal/service/line/spin.go`

**Проблема:** Операции с балансом не атомарны - между чтением и записью баланс может измениться

**Пример:**

```79:81:internal/service/cascade/spin.go
balance -= req.Bet
if err := s.userRepo.UpdateBalance(ctx, userID, balance); err != nil {
```

**Решение:** Использовать транзакции или атомарные операции UPDATE с WHERE условием

## Архитектурные проблемы

### 6. Отсутствие dependency injection

**Файл:** `internal/app/service_provider.go`

**Проблема:** ServiceProvider создает зависимости лениво, но передает context в методы инициализации, что создает проблемы с жизненным циклом

**Пример:**

```68:81:internal/app/service_provider.go
func (sp *ServiceProvider) DBClient(ctx context.Context) *pgxpool.Pool {
```

**Решение:** Инициализировать все зависимости при старте приложения

### 7. Неиспользуемый код после return

**Файл:** `internal/app/service_provider.go:88`

**Проблема:** `return nil` после `panic` - недостижимый код

```87:89:internal/app/service_provider.go
panic("failed to create tx manager: " + err.Error())
return nil
```

### 8. Дублирование логики

**Проблема:** Методы `BuyBonus` и `Deposit` в cascade/line handlers почти идентичны

**Файлы:** `internal/api/cascade/cascade.go`, `internal/api/line/line.go`

**Решение:** Вынести общую логику в middleware или базовый handler

### 9. Отсутствие валидации входных данных

**Проблема:** Нет валидации DTO на уровне handlers

**Решение:** Добавить валидацию (например, через go-playground/validator)

### 10. Неправильная обработка ошибок в Refresh handler

**Файл:** `internal/api/auth/auth.go:118`

**Проблема:** Устанавливается refresh_token cookie вместо access_token

```118:internal/api/auth/auth.go
setRefreshTokenCookie(w, accessToken)
```

**Решение:** Исправить на установку access_token в теле ответа

## Проблемы с обработкой ошибок

### 11. Потеря контекста ошибок

**Проблема:** Множество мест где ошибки оборачиваются в `errors.New()` без контекста

**Пример:**

```22:internal/service/auth/login.go
return nil, errors.New("invalid password")
```

**Решение:** Использовать `fmt.Errorf` с `%w` для wrapping

### 12. Неинформативные сообщения об ошибках

**Проблема:** Клиент получает общие сообщения типа "register failed"

**Файл:** `internal/api/auth/auth.go:43`

**Решение:** Разделить ошибки на типы и возвращать более информативные сообщения

### 13. Игнорирование ошибок

**Файл:** `internal/service/line/spin.go:129`

**Проблема:** Ошибка игнорируется

```129:internal/service/line/spin.go
_ = s.repo.UpdateFreeSpinCount(ctx, userID, currentFree+res.AwardedFreeSpins)
```

## Проблемы с базой данных

### 14. Отсутствие транзакций в критических операциях

**Проблема:** Операции спина не атомарны - баланс списывается отдельно от начисления выигрыша

**Файл:** `internal/service/cascade/spin.go`

**Решение:** Обернуть всю логику спина в транзакцию

### 15. Race condition в UpdateFreeSpinCount

**Файлы:** `internal/repository/cascade_repo/repository.go`, `internal/repository/line_repo/repository.go`

**Проблема:** Update + Insert паттерн не атомарный

**Решение:** Использовать INSERT ... ON CONFLICT DO UPDATE (PostgreSQL UPSERT)

### 16. Отсутствие индексов (предположительно)

**Проблема:** Нет миграций, невозможно проверить наличие индексов

**Решение:** Добавить систему миграций (golang-migrate/migrate)

## Проблемы с кодом

### 17. Магические числа

**Проблема:** Хардкод значений (10 фриспинов, 30 дней и т.д.)

**Примеры:**

- `internal/service/cascade/buy_bonus.go:34` - `UpdateFreeSpinCount(ctx, userID, 10)`
- `internal/api/auth/auth.go:156` - `MaxAge: 60 * 60 * 24 * 30`

**Решение:** Вынести в конфигурацию

### 18. Неиспользуемые импорты

**Файл:** `internal/repository/line_repo/repository.go:6`

**Проблема:** Импорт `database/sql` используется только для `sql.ErrNoRows`, но используется `pgx.ErrNoRows`

**Решение:** Удалить неиспользуемый импорт

### 19. Неправильная работа с context

**Проблема:** Context передается в методы инициализации, но должен использоваться только для запросов

**Решение:** Убрать context из методов ServiceProvider

### 20. Отсутствие логирования

**Проблема:** Используется только `log.Printf`, нет структурированного логирования

**Решение:** Добавить structured logging (zap, logrus)

### 21. Отсутствие метрик и мониторинга

**Проблема:** Нет метрик для отслеживания производительности и ошибок

**Решение:** Добавить Prometheus метрики

## Проблемы с тестированием

### 22. Отсутствие тестов

**Проблема:** Нет unit/integration тестов

**Решение:** Добавить тесты для критических компонентов

## Проблемы с конфигурацией

### 23. Хардкод путей к конфигурационным файлам

**Файл:** `internal/app/service_provider.go:99, 142`

**Проблема:** `"config.yaml"` захардкожен

**Решение:** Использовать переменные окружения или флаги

### 24. Отсутствие валидации конфигурации

**Проблема:** Нет проверки корректности значений конфигурации

**Решение:** Добавить валидацию при загрузке конфигурации

## Проблемы с производительностью

### 25. Неэффективная работа с JSON

**Файл:** `internal/repository/cascade_repo/repository.go`

**Проблема:** Массивы 7x7 сериализуются/десериализуются при каждом запросе

**Решение:** Рассмотреть использование PostgreSQL массивов или оптимизировать структуру

### 26. Отсутствие connection pooling настройки

**Проблема:** Используются дефолтные настройки пула соединений

**Решение:** Настроить параметры пула через pgxpool.Config

## Дополнительные улучшения

### 27. Добавить graceful shutdown

**Файл:** `internal/app/app.go`

**Решение:** Обработка сигналов для корректного завершения

### 28. Добавить health check endpoint

**Решение:** Endpoint для проверки состояния приложения и БД

### 29. Улучшить структуру ошибок

**Решение:** Создать кастомные типы ошибок с кодами

### 30. Добавить request ID для трейсинга

**Решение:** Middleware для генерации и передачи request ID

## Приоритеты исправлений

**Критично (немедленно):**

1. Race conditions в балансе (п.5)
2. Небезопасные cookie (п.2)
3. CORS "*" (п.3)
4. Ошибка в Refresh handler (п.10)

**Высокий приоритет:**

5. Транзакции для спина (п.14)
6. UPSERT для репозиториев (п.15)
7. Убрать panic (п.1)
8. Добавить rate limiting (п.4)

**Средний приоритет:**

9. Dependency injection (п.6)
10. Валидация входных данных (п.9)
11. Структурированное логирование (п.20)
12. Graceful shutdown (п.27)

**Низкий приоритет:**

13. Рефакторинг дублирования (п.8)
14. Магические числа (п.17)
15. Тесты (п.22)